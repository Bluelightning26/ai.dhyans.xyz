<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hack Club AI Chat</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/marked.min.js"></script>
</head>
<body>
<header>
    <div class="header-content">
        <div class="logo">
            <a href="/">Hack Club AI Chat</a>
        </div>
        <nav>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
            </ul>
        </nav>
    </div>
</header>

<div class="container">
    <div class="sidebar">
        <button id="newConversation">New Chat</button>
        <div id="conversationList"></div>
    </div>
    <div class="main-content">
        <h1>AI Chat</h1>
        <div class="model-info">
            <strong>Current Model:</strong> <span id="model">Loading...</span>
            <div class="thinking-toggle">
                <label for="thinkingToggle">
                    <input type="checkbox" id="thinkingToggle">
                    <span>Hide AI Thinking</span>
                </label>
            </div>
        </div>
        <div id="response"></div>
        <form id="chatForm">
            <input type="text" id="message" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<footer>
    <div class="footer-content">
        <p>Made by Dhyan & Utilizes <a target="_blank" href="https://ai.hackclub.com">ai.hackclub.com</a></p>
        <p><strong> PERMITTED FOR USE ONLY BY HACK CLUBBERS IN THE SLACK</strong></p>
        <div class="footer-links">
            <a href="https://hackclub.com/slack" target="_blank">Join the Slack</a>
            <a href="https://github.com/Bluelightning26/ai.dhyans.xyz" target="_blank">GitHub</a>
        </div>
    </div>
</footer>

<script>
    let currentConversation = null;
    let noThinking = false;

    // Configure marked for markdown rendering
    if (typeof marked !== 'undefined') {
        marked.setOptions({
            breaks: true,
            gfm: true,
            tables: true,
            sanitize: false
        });
    }

    // Function to render markdown content
    function renderMarkdown(content) {
        if (typeof marked !== 'undefined') {
            return marked.parse(content);
        }
        return content; // Fallback if marked isn't loaded
    }

    fetch('https://ai.hackclub.com/model', {
        headers: {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
            'Accept': 'text/plain, */*'
        }
    })
        .then(res => res.text())
        .then(model => document.getElementById('model').textContent = model)
        .catch(() => document.getElementById('model').textContent = 'Claude 3 Sonnet');

    function updateConversationList() {
        fetch('/conversations')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('conversationList');
                list.innerHTML = '';
                currentConversation = data.current;

                data.conversations.forEach(id => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${id === currentConversation ? 'active' : ''}`;

                    const time = document.createElement('span');
                    time.textContent = new Date(parseInt(id)).toLocaleTimeString();

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteConversation(id);
                    };

                    item.appendChild(time);
                    item.appendChild(deleteBtn);
                    item.onclick = () => switchConversation(id);
                    list.appendChild(item);
                });
            })
            .catch(err => {
                console.error('Error fetching conversations:', err);
            });
    }

    function deleteConversation(id) {
        fetch(`/conversation/${id}`, { method: 'DELETE' })
            .then(() => {
                updateConversationList();
                if (id === currentConversation) {
                    document.getElementById('response').textContent = '';
                }
            })
            .catch(err => {
                console.error('Error deleting conversation:', err);
            });
    }

    function switchConversation(id) {
        fetch('/switch-conversation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        })
            .then(res => res.json())
            .then(data => {
                currentConversation = id;
                displayMessages(data.messages);
                updateConversationList();
            })
            .catch(err => {
                console.error('Error switching conversation:', err);
            });
    }

    function displayMessages(messages) {
        const responseEl = document.getElementById('response');
        if (!messages || messages.length === 0) {
            responseEl.textContent = '';
            return;
        }

        responseEl.innerHTML = messages.map(m => {
            const role = m.role === 'user' ? 'You' : 'AI';
            if (m.role === 'assistant') {
                return `<div class="message ${m.role}"><strong>${role}:</strong> <div class="message-content">${renderMarkdown(m.content)}</div></div>`;
            } else {
                return `<div class="message ${m.role}"><strong>${role}:</strong> ${m.content}</div>`;
            }
        }).join('');
    }

    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const message = messageInput.value;

        if (!message.trim()) return;

        const responseEl = document.getElementById('response');
        const userMessageEl = document.createElement('div');
        userMessageEl.className = 'message user';
        userMessageEl.innerHTML = `<strong>You:</strong> ${message}`;
        responseEl.appendChild(userMessageEl);

        messageInput.value = '';
        messageInput.disabled = true;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await res.json();

            if (data.choices?.[0]?.message?.content) {
                const aiMessageEl = document.createElement('div');
                aiMessageEl.className = 'message assistant';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = renderMarkdown(data.choices[0].message.content);

                aiMessageEl.innerHTML = '<strong>AI:</strong> ';
                aiMessageEl.appendChild(contentDiv);
                responseEl.appendChild(aiMessageEl);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            const errorEl = document.createElement('div');
            errorEl.className = 'message error';
            errorEl.textContent = 'Failed to send message. Please try again.';
            responseEl.appendChild(errorEl);
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    });

    document.getElementById('newConversation').addEventListener('click', async () => {
        try {
            await fetch('/new-conversation', { method: 'POST' });
            document.getElementById('response').textContent = '';
            document.getElementById('message').value = '';
            updateConversationList();
        } catch (err) {
            console.error('Error creating new conversation:', err);
        }
    });

    // Initial load of conversations
    updateConversationList();

    function initThinkingMode() {
        fetch('/thinking-mode')
            .then(res => res.json())
            .then(data => {
                noThinking = data.noThinking;
                document.getElementById('thinkingToggle').checked = noThinking;
            })
            .catch(err => {
                console.error('Error fetching thinking mode:', err);
            });
    }

    document.getElementById('thinkingToggle').addEventListener('change', function() {
        noThinking = this.checked;
        fetch('/thinking-mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ noThinking })
        })
            .catch(err => {
                console.error('Error updating thinking mode:', err);
            });
    });


    initThinkingMode();

</script>
</body>
</html>