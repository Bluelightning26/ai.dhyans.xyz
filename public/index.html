<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hack Club AI Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="sidebar">
        <button id="newConversation">New Chat</button>
        <div id="conversationList"></div>
    </div>
    <div class="main-content">
        <h1>AI Chat</h1>
        <div class="model-info">
            <strong>Current Model:</strong> <span id="model">Loading...</span>
        </div>
        <div id="response"></div>
        <form id="chatForm">
            <input type="text" id="message" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>
</div>
<script>
    let currentConversation = null;

    // Load model information directly from Hack Club API
    fetch('https://ai.hackclub.com/model', {
        headers: {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
            'Accept': 'text/plain, */*'
        }
    })
        .then(res => res.text())
        .then(model => document.getElementById('model').textContent = model)
        .catch(() => document.getElementById('model').textContent = 'Claude 3 Sonnet');

    function updateConversationList() {
        fetch('/conversations')
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById('conversationList');
                list.innerHTML = '';
                currentConversation = data.current;

                data.conversations.forEach(id => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${id === currentConversation ? 'active' : ''}`;

                    const time = document.createElement('span');
                    time.textContent = new Date(parseInt(id)).toLocaleTimeString();

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteConversation(id);
                    };

                    item.appendChild(time);
                    item.appendChild(deleteBtn);
                    item.onclick = () => switchConversation(id);
                    list.appendChild(item);
                });
            })
            .catch(err => {
                console.error('Error fetching conversations:', err);
            });
    }

    function deleteConversation(id) {
        fetch(`/conversation/${id}`, { method: 'DELETE' })
            .then(() => {
                updateConversationList();
                if (id === currentConversation) {
                    document.getElementById('response').textContent = '';
                }
            })
            .catch(err => {
                console.error('Error deleting conversation:', err);
            });
    }

    function switchConversation(id) {
        fetch('/switch-conversation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        })
            .then(res => res.json())
            .then(data => {
                currentConversation = id;
                displayMessages(data.messages);
                updateConversationList();
            })
            .catch(err => {
                console.error('Error switching conversation:', err);
            });
    }

    function displayMessages(messages) {
        const responseEl = document.getElementById('response');
        if (!messages || messages.length === 0) {
            responseEl.textContent = '';
            return;
        }

        responseEl.innerHTML = messages.map(m => {
            const role = m.role === 'user' ? 'You' : 'AI';
            return `<div class="message ${m.role}"><strong>${role}:</strong> ${m.content}</div>`;
        }).join('');
    }

    document.getElementById('chatForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const message = messageInput.value;

        if (!message.trim()) return;

        // Show user message immediately
        const responseEl = document.getElementById('response');
        const userMessageEl = document.createElement('div');
        userMessageEl.className = 'message user';
        userMessageEl.innerHTML = `<strong>You:</strong> ${message}`;
        responseEl.appendChild(userMessageEl);

        messageInput.value = '';
        messageInput.disabled = true;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            const data = await res.json();

            if (data.choices?.[0]?.message?.content) {
                const aiMessageEl = document.createElement('div');
                aiMessageEl.className = 'message assistant';
                aiMessageEl.innerHTML = `<strong>AI:</strong> ${data.choices[0].message.content}`;
                responseEl.appendChild(aiMessageEl);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            const errorEl = document.createElement('div');
            errorEl.className = 'message error';
            errorEl.textContent = 'Failed to send message. Please try again.';
            responseEl.appendChild(errorEl);
        } finally {
            messageInput.disabled = false;
            messageInput.focus();
        }
    });

    document.getElementById('newConversation').addEventListener('click', async () => {
        try {
            await fetch('/new-conversation', { method: 'POST' });
            document.getElementById('response').textContent = '';
            document.getElementById('message').value = '';
            updateConversationList();
        } catch (err) {
            console.error('Error creating new conversation:', err);
        }
    });

    // Initial load of conversations
    updateConversationList();
</script>
</body>
</html>